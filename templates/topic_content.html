<!DOCTYPE html>
{% from 'macros.html' import avatar, user_info, pager, field, submit %}
{% set COUNT_SUBPOST = config['count_subpost'] | int %}
<html>
  <head>
    <meta charset="UTF-8" />
    <title>{{ topic_info['title'] ~ ' - ' ~ config['site_name'] }}</title>
    <link rel="stylesheet" href="/static/global.css" />
    <style>
     ol { list-style-type: none; padding: 0; }
     h1 { font-size: 1.5em; }
     header + hr { margin-bottom: 0; }
     #post_list { margin-top: 0; }
     .date { font-size: 85%; color: hsl(0, 0%, 57%); }
     .post {
	 display: flex;
	 width: 55em;
	 word-wrap: break-word;
	 border-bottom: 1px solid hsl(0, 0%, 75%);
     }
     .container_left {
	 flex-shrink: 0;
	 width: 10em;
	 display: flex;	 
	 flex-direction: column;
	 align-items: center;
	 /*	 background-color: hsl(0, 0%, 97%);*/
	 border-right: 1px solid hsl(0, 0%, 93%);
     }
     .container_left > :first-child {
	 margin-top: 1.5em;
	 margin-bottom: 0.2em;
     }
     .container_right {
	 flex-grow: 1;
	 padding: 1.85em 1.5em 0.55em 1.5em;
	 min-width: 0;
     }
     .float_right_box { display: flex; justify-content: flex-end; }
     .post_body { min-height: 16em; white-space: pre-wrap; }
     .post_subpost_list {
	 margin: 0.5em 0em;
	 border: 1px solid hsl(0, 0%, 93%);
	 background-color: hsl(0, 0%, 97%);
     }
     .post_subpost_list.empty:not(.expanded) {
	 border: none;
	 background-color: hsla(0, 0%, 0%, 0);
     }
     .post_subpost_list.empty:not(.expanded) > .subpost_list_footer {
	 padding: 0;
     }
     .subpost {
	 display: flex;
	 align-items: flex-start;
	 padding: 0.8em 1em 0.6em 1em;
     }
     .subpost:not(:last-child) {
	 border-bottom: 1px dotted hsl(0, 0%, 85%);
     }
     .subpost_author_name::after { content: ":"; }
     .subpost_content { white-space: pre-wrap; }
     .subpost_left_container { flex-shrink: 0; margin-right: 0.8em; }
     .subpost_right_container { flex-grow: 1; min-width: 0; }
     .subpost_list_footer:not(.empty) {
	 padding: 0.5em 1em;
	 border-top: 1px dotted hsl(0, 0%, 85%);
     }
     .subpost_list_footer .pager > .page_link {
	 font-size: 100%;
	 border: none;
	 padding: 0;
	 margin: 0em 0.25em;
     }
     .pager_and_reply_btn_wrapper {
	 display: flex;
	 justify-content: space-between;
     }
     .reply_submit_btn_wrapper {
	 display: flex;
	 justify-content: space-between;
     }
     .reply_form { display: none; }
     .reply_form > [name="content"] {
	 box-sizing: border-box;
	 width: 100%;
	 margin: 0.5em 0em;
     }
     #add_post_form { width: 45em; }
     #add_post_form > [name="content"] { box-sizing: border-box; width: 100%; }
    </style>
    <template id="template_subpost" style="display: none;">
      {# This is front-end part. Don't forget back-end part. #}
      <li class="subpost" id="s0">
        <div class="subpost_left_container">
          {{ avatar('aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa', 2) }}
        </div>
        <div class="subpost_right_container">
          <div class="subpost_body">
            <span class="subpost_author_name"></span>
            <span class="subpost_content"></span>
          </div>
          <div class="subpost_footer float_right_box">
            <div class="subpost_info">
              <span class="date"></span>
            </div>
          </div>
        </div>
      </li>
    </template>
    <script type="text/javascript" src="/static/toolkit.js"></script>
    <script type="text/javascript" src="/static/form.js"></script>
    <script type="text/javascript">
     var COUNT_SUBPOST = '{{ COUNT_SUBPOST }}';
    </script>
    <script type="text/javascript">
     var add_post_form_controller;
     var reply_controllers = {};
     /**
      * Event handler for click event of subpost pager
      *
      * @param String pid
      * @param String pn
      * @return void
      */
     function refresh_subpost_list(pid, pn) {
	 var list = query(printf('.subpost_list[data-pid="%1"]', pid));
	 var pager = query(
	     printf('.subpost_list_pager[data-pid="%1"] > .pager', pid)
	 );
	 if(pager.querySelector('.page_current').textContent == pn)
	     return;
	 if(pager.classList.contains('lock'))
	     return;
	 pager.classList.add('lock');
	 GET(
	     '{{ url_for('post_list') }}',
	     {
		 parent: pid,
		 pn: pn,
		 count: COUNT_SUBPOST,
		 subpost: '1'
	     },
	     function(xhr) {
		 pager.classList.remove('lock');
		 var result = JSON.parse(xhr.responseText);
		 if(result.code == 0) {
		     while(list.firstChild)
			 list.removeChild(list.firstChild);
		     let first_subpost_id = result.data.list[0].sid;
		     for(let subpost of result.data.list) {
			 let item = document.importNode(
			     template_subpost, true
			 ).content;
			 item.querySelector('.subpost').id = (
			     's' + subpost.sid
			 );
			 let avatar = item.querySelector('.avatar');
			 avatar.src = avatar.src.replace(
			     'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa',
			     subpost.author.mail
			 )
			 item.querySelector(
			     '.subpost_author_name'
			 ).textContent = subpost.author.name;
			 item.querySelector(
			     '.subpost_content'
			 ).textContent = subpost.content;
			 item.querySelector(
			     '.subpost_info > .date'
			 ).textContent = format_date(subpost.date);
			 list.appendChild(item);
		     }
		     for(let link of pager.querySelectorAll('.page_link')) {
			 if(link.classList.contains('page_current'))
			     link.classList.remove('page_current');
			 if(link.textContent == pn)
			     link.classList.add('page_current');
		     }
		     location.hash = 's' + first_subpost_id;
		 } else {
		     alert(result.msg);
		 }
	     },
	     function(status, text) {
		 pager.classList.remove('lock');
		 if(status != 0)
		     alert(printf(_('Error: %1 %2'), status, text));
		 else
		     alert(_('Connection Error or Timeout'));
	     }
	 )
     }
     function init_form() {
	 if(typeof add_post_form == 'undefined')
	     return;
	 add_post_form_controller = new AjaxForm(
	     add_post_form,
	     '{{ url_for('post_add') }}',
	     false,
	     location.pathname
	 );
	 for(let I of query_all('.post_subpost_list')) {
	     let list = I;
	     let reply_btn = list.querySelector('.reply_btn');
	     let form = list.querySelector('.reply_form');
	     let controller = new AjaxForm(
		 form,
		 '{{ url_for('post_add') ~ '?subpost=1' }}',
		 false,
		 ''
	     );
	     reply_controllers[form.dataset.pid] = controller;
	     reply_btn.addEventListener('click', function() {
		 if(list.classList.contains('expanded')) {
		     form.style.display = "none";
		     list.classList.remove('expanded');
		 } else {
		     form.style.display = "block";
		     list.classList.add('expanded');
		 }
	     });
	 }
     }
     function init() {
	 init_form();
	 for(let I of query_all('.subpost_list_pager > .pager')) {
	     let pid = I.parentElement.dataset.pid;
	     for(let J of I.querySelectorAll('.page_link')) {
		 let link = J;
		 link.addEventListener('click', function() {
		     refresh_subpost_list(pid, link.textContent);
		 });
	     }
	 }
     }
     window.addEventListener('load', init);
    </script>
  </head>
  <body class="box_horizontal_center">
    <div id="container">
      {{ user_info() }}
      <header>
	<h1>{{ topic_info['title'] }}</h1>
      </header>
      <hr/>
      <ol id="post_list">
	{% for post in data['list'] %}
	  <li class="post" id="p{{ post['pid'] }}">
	    <div class="container_left">
	      {{ avatar(post['author']['mail'], 6) }}
	      <div class="name">{{ post['author']['name'] }}</div>
	    </div>
	    <div class="container_right">
	      <div class="post_body">{{ post['content'] }}</div>
	      <div class="post_footer float_right_box">
		<div class="post_info">
		  <span class="date">{{ post['date'] | date }}</span>
		</div>
	      </div>
	      <div class="post_subpost_list{% if not post['subposts']['list'] %} empty{% endif %}">
		<ol class="subpost_list" data-pid="{{ post['pid'] }}">
		  {% for subpost in post['subposts']['list'] %}
		    {# This is back-end part. Don't forget front-end part. #}
		    <li class="subpost" id="s{{ subpost['sid'] }}">
		      <div class="subpost_left_container">
			{{ avatar(subpost['author']['mail'], 2) }}
		      </div>
		      <div class="subpost_right_container">
			<div class="subpost_body">
			  <span class="subpost_author_name">{{ subpost['author']['name'] }}</span>
			  <span class="subpost_content">{{ subpost['content'] }}</span>
			</div>
			<div class="subpost_footer float_right_box">
			  <div class="subpost_info">
			    <span class="date">{{ subpost['date'] | date }}</span>
			  </div>
			</div>
		      </div>
		    </li>
		  {% endfor %}
		</ol>
		<div class="subpost_list_footer{% if not session.get('uid') and post['subposts']['count'] <= COUNT_SUBPOST %} empty{% endif %}">
		    <div class="pager_and_reply_btn_wrapper">
		      <div class="subpost_list_pager" data-pid="{{ post['pid'] }}">
			{{ pager(post['subposts']['count'], COUNT_SUBPOST, 1, ajax=True) }}
		      </div>
		      {% if session.get('uid') %}
			<a class="reply_btn" href="javascript:void(0)">{{ _('Reply') }}</a>
		      {% endif %}
		    </div>
		  {% if session.get('uid') %}
		    <form class="reply_form" data-pid="{{ post['pid'] }}" action="javascript:void(0)">
		      <input type="hidden" name="parent" value="{{ post['pid'] }}" />
		      <input type="hidden" name="reply" value="0" />
		      <textarea name="content" autocomplete="off"></textarea>
		      <div class="reply_submit_btn_wrapper">
			<span class="message"></span>
			{{ submit(_('Reply')) }}
		      </div>
		    </form>
		  {% endif %}
		</div>
	      </div>
	    </div>
	  </li>
	{% endfor %}
      </ol>
      {% if session.get('uid') %}
	<p class="bold">Reply this topic</p>
	<form id="add_post_form" action="javascript:void(0)">
	  <input type="hidden" name="parent" value="{{ tid }}" />
	  <textarea name="content" rows="12" placeholder="[Input Content Here]" required="required"></textarea>
          <p class="message"></p>
          {{ submit(_('Reply')) }}
	</form>
      {% endif %}
    </div>
  </body>
</html>
